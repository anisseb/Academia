rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Fonction pour vérifier si l'utilisateur est admin
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).profile.role == 'admin';
    }
    
    // Règles pour les utilisateurs
    match /users/{userId} {
      // L'utilisateur peut lire et écrire ses propres données
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Pour la fonctionnalité des amis, permettre la lecture des informations de base
      // (nom, photo, statut en ligne, etc.) pour tous les utilisateurs authentifiés
      allow read: if request.auth != null;
      
      // Les admins peuvent tout faire sur tous les utilisateurs
      allow read, write: if isAdmin();
    }
    
    // Règles pour les exercices
    match /exercises/{exerciseId} {
      // Lecture publique pour tous les utilisateurs authentifiés
      allow read: if request.auth != null;
      // Écriture réservée aux administrateurs
      allow write: if isAdmin();
    }
    
    // Règles pour les sessions
    match /sessions/{userId} {
      // L'utilisateur peut lire et écrire ses propres sessions
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Les admins peuvent tout faire sur toutes les sessions
      allow read, write: if isAdmin();
    }
    
    // Règles pour les pays, types d'écoles, classes, matières
    match /countries/{countryId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /schoolTypes/{schoolTypeId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /classes/{classId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /subjects/{subjectId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // Règles pour les feedbacks (documents avec arrays)
    match /feedback/{feedbackType} {
      // Les utilisateurs authentifiés peuvent lire et mettre à jour les documents de feedback
      allow read, update: if request.auth != null && 
        (feedbackType == 'bugs' || feedbackType == 'satisfaction' || feedbackType == 'suggestions');
      // Création réservée au système (les documents sont créés une seule fois)
      allow create: if false;
      // Suppression réservée aux administrateurs
      allow delete: if isAdmin();
    }
      
    // Règles pour les chapitres
    match /chapters/{chapterId} {
      // Lecture publique pour tous les utilisateurs authentifiés
      allow read: if request.auth != null;
      // Écriture réservée aux administrateurs
      allow write: if isAdmin();
    }
    
    // Règles pour la collection theme (singulier)
    match /theme/{themeId} {
      // Lecture publique pour tous les utilisateurs authentifiés
      allow read: if request.auth != null;
      // Écriture réservée aux administrateurs
      allow write: if isAdmin();
    }
    
    // Règles pour les expressions quotidiennes
    match /dailyExpression/{expressionId} {
      // Lecture publique pour tous les utilisateurs authentifiés
      allow read: if request.auth != null;
      // Écriture réservée aux administrateurs
      allow write: if isAdmin();
    }
    
    // Règles pour les motivations quotidiennes
    match /dailyMotivation/{motivationId} {
      // Lecture publique pour tous les utilisateurs authentifiés
      allow read: if request.auth != null;
      // Écriture réservée aux administrateurs
      allow write: if isAdmin();
    }
    
    // Règles pour les threads
    match /threads/{userId} {
      // L'utilisateur peut lire et écrire ses propres threads
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Les admins peuvent tout faire sur tous les threads
      allow read, write: if isAdmin();
    }
    
    // Règles par défaut - refuser tout accès non autorisé
    match /{document=**} {
      allow read, write: if false;
    }
  }
}